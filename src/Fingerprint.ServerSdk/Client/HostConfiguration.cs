/* 
 * Fingerprint Server API
 *
 * Fingerprint Server API allows you to search, update, and delete identification events in a server environment. It can be used for data exports, decision-making, and data analysis scenarios. Server API is intended for server-side usage, it's not intended to be used from the client side, whether it's a browser or a mobile device. 
 *
 * The version of the OpenAPI document: 4
 * Contact: support@fingerprint.com
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */
using System;
using System.Collections.Generic;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using System.Net.Http.Headers;
using Microsoft.Extensions.DependencyInjection;
using Fingerprint.ServerSdk.Api;
using Fingerprint.ServerSdk.Model;

namespace Fingerprint.ServerSdk.Client
{
    /// <summary>
    /// Provides hosting configuration for Fingerprint.ServerSdk
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new();

        /// <summary>
        /// Indicates whether at least one API token has been registered
        /// </summary>
        private bool TokenAdded { get; set; }

        /// <summary>
        /// Indicates whether HTTP clients for the SDK have been added to the service collection.
        /// </summary>
        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// The User-Agent header value sent with SDK HTTP requests.
        /// Defaults to <c>fingerprint-dotnet-sdk/{ClientUtils.ClientVersion}</c>.
        /// </summary>
        public string UserAgent { get; set; } = $"fingerprint-dotnet-sdk/{ClientUtils.ClientVersion}";

        /// <summary>
        /// The API region used to resolve the default base URL when <see cref="BaseUrl"/> is not provided.
        /// Defaults to <see cref="Region.Us"/>.
        /// </summary>
        public Region Region { get; set; } = Region.Us;

        /// <summary>
        /// Optional absolute base URL that overrides region resolution.
        /// When set, <see cref="Region"/> is ignored for base URL calculation.
        /// </summary>
        public string BaseUrl { get; set; }

        /// <summary>
        /// Creates a new <see cref="HostConfiguration"/> and registers core SDK singletons. 
        /// </summary>
        /// <param name="services">Application service collection used for registration.</param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new BotFilterJsonConverter());
            _jsonOptions.Converters.Add(new BotFilterNullableJsonConverter());
            _jsonOptions.Converters.Add(new BotResultJsonConverter());
            _jsonOptions.Converters.Add(new BotResultNullableJsonConverter());
            _jsonOptions.Converters.Add(new BrowserDetailsJsonConverter());
            _jsonOptions.Converters.Add(new CanvasJsonConverter());
            _jsonOptions.Converters.Add(new EmojiJsonConverter());
            _jsonOptions.Converters.Add(new ErrorJsonConverter());
            _jsonOptions.Converters.Add(new ErrorCodeJsonConverter());
            _jsonOptions.Converters.Add(new ErrorCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new ErrorResponseJsonConverter());
            _jsonOptions.Converters.Add(new EventJsonConverter());
            _jsonOptions.Converters.Add(new EventRuleActionJsonConverter());
            _jsonOptions.Converters.Add(new EventRuleActionAllowJsonConverter());
            _jsonOptions.Converters.Add(new EventRuleActionBlockJsonConverter());
            _jsonOptions.Converters.Add(new EventSearchJsonConverter());
            _jsonOptions.Converters.Add(new EventUpdateJsonConverter());
            _jsonOptions.Converters.Add(new FontPreferencesJsonConverter());
            _jsonOptions.Converters.Add(new GeolocationJsonConverter());
            _jsonOptions.Converters.Add(new GeolocationSubdivisionsInnerJsonConverter());
            _jsonOptions.Converters.Add(new IPBlockListJsonConverter());
            _jsonOptions.Converters.Add(new IPInfoJsonConverter());
            _jsonOptions.Converters.Add(new IPInfoV4JsonConverter());
            _jsonOptions.Converters.Add(new IPInfoV6JsonConverter());
            _jsonOptions.Converters.Add(new IdentificationJsonConverter());
            _jsonOptions.Converters.Add(new IdentificationConfidenceJsonConverter());
            _jsonOptions.Converters.Add(new IntegrationJsonConverter());
            _jsonOptions.Converters.Add(new IntegrationSubintegrationJsonConverter());
            _jsonOptions.Converters.Add(new PluginsInnerJsonConverter());
            _jsonOptions.Converters.Add(new PluginsInnerMimeTypesInnerJsonConverter());
            _jsonOptions.Converters.Add(new ProximityJsonConverter());
            _jsonOptions.Converters.Add(new ProxyConfidenceJsonConverter());
            _jsonOptions.Converters.Add(new ProxyConfidenceNullableJsonConverter());
            _jsonOptions.Converters.Add(new ProxyDetailsJsonConverter());
            _jsonOptions.Converters.Add(new RawDeviceAttributesJsonConverter());
            _jsonOptions.Converters.Add(new RequestHeaderModificationsJsonConverter());
            _jsonOptions.Converters.Add(new RuleActionHeaderFieldJsonConverter());
            _jsonOptions.Converters.Add(new RuleActionTypeJsonConverter());
            _jsonOptions.Converters.Add(new RuleActionTypeNullableJsonConverter());
            _jsonOptions.Converters.Add(new SDKJsonConverter());
            _jsonOptions.Converters.Add(new SdkPlatformFilterJsonConverter());
            _jsonOptions.Converters.Add(new SdkPlatformFilterNullableJsonConverter());
            _jsonOptions.Converters.Add(new SupplementaryIDHighRecallJsonConverter());
            _jsonOptions.Converters.Add(new TamperingDetailsJsonConverter());
            _jsonOptions.Converters.Add(new TouchSupportJsonConverter());
            _jsonOptions.Converters.Add(new TriggeredByInnerJsonConverter());
            _jsonOptions.Converters.Add(new VelocityJsonConverter());
            _jsonOptions.Converters.Add(new VelocityDataJsonConverter());
            _jsonOptions.Converters.Add(new VpnConfidenceJsonConverter());
            _jsonOptions.Converters.Add(new VpnConfidenceNullableJsonConverter());
            _jsonOptions.Converters.Add(new VpnConfidenceFilterJsonConverter());
            _jsonOptions.Converters.Add(new VpnConfidenceFilterNullableJsonConverter());
            _jsonOptions.Converters.Add(new VpnMethodsJsonConverter());
            _jsonOptions.Converters.Add(new WebGlBasicsJsonConverter());
            _jsonOptions.Converters.Add(new WebGlExtensionsJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new JsonSerializerOptionsProvider(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<FingerprintApiEvents>();
        }

        /// <summary>
        /// Registers and configures the SDK <see cref="HttpClient"/> instances used by <see cref="IFingerprintApi"/>.
        /// Requires tokens to be added beforehand.
        /// </summary>
        /// <param name="client">Optional per-client configuration</param>
        /// <param name="builder">Optional hook to customize the created <see cref="IHttpClientBuilder"/></param>
        /// <returns>The current <see cref="HostConfiguration"/> for chaining.</returns>
        /// <exception cref="InvalidOperationException">Thrown when no API tokens were added prior to calling this method.</exception>
        public HostConfiguration AddApiHttpClients(Action<HttpClient> client = null, Action<IHttpClientBuilder> builder = null)
        {
            if (!TokenAdded)
            {
                throw new InvalidOperationException(
                    "No API tokens provided. Call options.AddTokens(new BearerToken(\"<SECRET_API_KEY>\")) before AddApiHttpClients."
                );
            }

            if (client == null)
            {
                client = c =>
                {
                    c.BaseAddress = ResolveBaseUri();
                    c.DefaultRequestHeaders.UserAgent.Add(ProductInfoHeaderValue.Parse(UserAgent));
                };
            }
            else
            {
                // Override custom client's base address if it's empty.
                var customClient = client;
                client = c =>
                {
                    customClient(c);
                    if (c.BaseAddress is null)
                    {
                        c.BaseAddress = ResolveBaseUri();
                        c.DefaultRequestHeaders.UserAgent.Add(ProductInfoHeaderValue.Parse(UserAgent));
                    }
                };
            }

            var builders = new List<IHttpClientBuilder>
            {
                _services.AddHttpClient<IFingerprintApi, FingerprintApi>(client)
            };

            if (builder != null)
                foreach (var instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Allows customizing the JSON serialization options used by the SDK.
        /// </summary>
        /// <param name="options">A delegate that mutates the <see cref="JsonSerializerOptions"/> instance.</param>
        /// <returns>The current <see cref="HostConfiguration"/> for chaining.</returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds a single token to the service collection (e.g. <see cref="BearerToken"/>)
        /// </summary>
        /// <typeparam name="TTokenBase">Token base type.</typeparam>
        /// <param name="token">The token instance to register.</param>
        /// <returns>The current <see cref="HostConfiguration"/> for chaining.</returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            TokenAdded = true;
            return AddTokens(new[] { token });
        }

        /// <summary>
        /// Adds multiple tokens to the service collection.
        /// </summary>
        /// <typeparam name="TTokenBase">Token base type.</typeparam>
        /// <param name="tokens">A sequence of tokens to register.</param>
        /// <returns>The current <see cref="HostConfiguration"/> for chaining.</returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            var container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(_ => container);

            if (container.Tokens.Count > 0)
            {
                TokenAdded = true;
            }

            return this;
        }

        /// <summary>
        /// Registers a token provider in the service collection.
        /// </summary>
        /// <typeparam name="TTokenProvider">Provider type.</typeparam>
        /// <typeparam name="TTokenBase">Token base type produced by the provider.</typeparam>
        /// <returns>The current <see cref="HostConfiguration"/> for chaining.</returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>()
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }

        /// <summary>
        /// Resolves the base API URI using <see cref="BaseUrl"/> if provided; otherwise by <see cref="Region"/>.
        /// </summary>
        /// <remarks>
        /// If <see cref="BaseUrl"/> is non-empty, it is used directly.
        /// Otherwise, the default URL for <see cref="Region"/> is returned.
        /// </remarks>
        /// <returns>The resolved <see cref="Uri"/>.</returns>
        private Uri ResolveBaseUri()
        {
            return !string.IsNullOrWhiteSpace(BaseUrl) ? new Uri(BaseUrl) : Region.GetBaseUri();
        }
    }
}